<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Voice Bot</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
        }

        #chat-container {
            width: 90%;
            max-width: 600px;
            height: 80%;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #chat-log {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            border-bottom: 1px solid #e0e0e0;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 70%;
            word-wrap: break-word;
            line-height: 1.5;
        }

        .user-message {
            background-color: #007bff;
            color: #fff;
            margin-left: auto;
        }

        .bot-message {
            background-color: #e9ecef;
            color: #333;
            margin-right: auto;
        }

        .icon-btn {
            background-color: #007bff;
            border: none;
            cursor: pointer;
            padding: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            transition: background-color 0.3s, transform 0.2s ease-in-out;
            margin: 20px auto;
        }

        .icon-btn:hover {
            background-color: #0056b3;
        }

        .icon-btn.recording {
            background-color: #dc3545;
            animation: pulse 1s infinite;
        }
        .icon-btn:disabled,
.icon-btn.disabled {
    background-color: #a0a0a0 !important;
    cursor: not-allowed;
    pointer-events: none;
    opacity: 0.7;
}

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        #mic-btn svg {
            width: 32px;
            height: 32px;
        }

    </style>
</head>
<body>

<div id="chat-container">
    <div id="chat-log"></div>
    <div id="mic-container">
        <button id="mic-btn" class="icon-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-mic-fill" viewBox="0 0 16 16">
              <path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z"/>
              <path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3.5 8V7a.5.5 0 0 1 .5-.5z"/>
            </svg>
        </button>
    </div>
</div>

<script>
    const chatLog = document.getElementById('chat-log');
    const micBtn = document.getElementById('mic-btn');
    let isRecording = false;
    let mediaRecorder;
    let audioChunks = [];
    
    // Function to add a message to the chat log
    function appendMessage(text, className) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${className}`;
        messageDiv.textContent = text;
        chatLog.appendChild(messageDiv);
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    // Add introductory messages when the page loads
    document.addEventListener('DOMContentLoaded', () => {
    appendMessage("Welcome! I’m Nova — a voice assistant designed to answer questions just like my creator would. Tap the microphone to start speaking, and tap it again when you're done.", 'bot-message');
    appendMessage("Try asking me one of these questions:", 'bot-message');
    appendMessage("Can you tell me your life story in a few sentences?", 'bot-message');
    appendMessage("What’s your #1 superpower?", 'bot-message');
    appendMessage("What are the top 3 areas you want to grow in?", 'bot-message');
});

    micBtn.onclick = () => {
        if (isRecording) {
            mediaRecorder.stop();
            micBtn.classList.remove('recording');
            isRecording = false;
        } else {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.start();
                    micBtn.classList.add('recording');
                    isRecording = true;
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        sendAudioToServer(audioBlob);
                    };
                })
                .catch(err => {
                    console.error('Error accessing microphone:', err);
                    alert('Could not access microphone. Please check permissions.');
                });
        }
    };

    function sendAudioToServer(audioBlob) {
    const formData = new FormData();
    formData.append('audio', audioBlob, 'recording.webm');

    // Add a placeholder message for the user's speech
    appendMessage('You: Processing your speech...', 'user-message');

    // Disable mic during fetch processing
    micBtn.disabled = true;
    micBtn.classList.add('disabled');

    fetch('/ask', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // Update the placeholder with the actual transcribed user text
        const userMessageElement = chatLog.lastElementChild;
        userMessageElement.textContent = `You: ${data.user_text}`;

        // Display the bot's response
        appendMessage(`Bot: ${data.bot_text}`, 'bot-message');

        // Play the audio (and re-enable mic after audio ends)
        playAudio(data.audio);
    })
    .catch(error => {
        console.error('Error:', error);
        appendMessage('Bot: Sorry, something went wrong.', 'bot-message');

        // Optional: Re-enable mic in case of error
        micBtn.disabled = false;
        micBtn.classList.remove('disabled');
    });
}
    function playAudio(hexAudio) {
    if (hexAudio) {
        try {
            const bytes = Uint8Array.from(hexAudio.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
            const audioBlob = new Blob([bytes], { type: 'audio/mpeg' });
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);

            // Disable mic button during playback
            micBtn.disabled = true;
            micBtn.classList.add('disabled');

            audio.play()
                .then(() => {
                    console.log("Bot audio playing...");
                })
                .catch(e => console.error("Audio playback error:", e));

            audio.onended = () => {
                console.log("Bot audio finished. Restarting mic...");

                // Re-enable mic button
                micBtn.disabled = false;
                micBtn.classList.remove('disabled');

                // Trigger mic again
            };
        } catch (e) {
            console.error("Error creating audio blob:", e);
        }
    }
}
</script>
<footer style="text-align: center; padding: 12px; font-size: 0.9em; color: #555;">
    © 2025 Nova Voice Assistant — Made  by <strong>Shri M Angesh</strong>
</footer>

</body>
</html>
